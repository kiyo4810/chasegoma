<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ゴマちゃんを追え</title>
    <style>
      /* ここは CSS（デザイン）の部屋 */
      body {
        margin: 0;
        overflow: hidden; /* スクロールバーが出ないようにする */
      }
      canvas {
        display: block; /* 隙間なく表示する */
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>

    <script>
      /* ここは JavaScript（命令）の部屋 */
      // let isGameStarted = false; // まだ始まっていないという「目印」
      let isGameStarted = false;
      // 1. 画用紙を捕まえる
      //   const canvas = document.getElementById("gameCanvas");
      const canvas = document.getElementById("gameCanvas");
      console.log(canvas);

      // 2. ペンを取り出す
      //const ctx = canvas.getContext("2d");
      const ctx = canvas.getContext("2d");
      //       console.log(ctx);
      // /* スクリプトの上のほう（canvasの定義の下あたり）に追加 */
      // let spriteX = 0;      // 横の位置
      // let spriteY = 0;      // 縦の位置
      // let vx = 2;           // 横のスピード（1フレームに何ピクセル進むか）
      // let vy = 2;           // 縦のスピード
      // const size = 200;     // ゴマちゃんのサイズ
      let spriteX = 0;
      let spriteY = 0;
      let vx = 2;
      let vy = 2;
      const size = 200;
      let score = 0; // スコア（最初は0点）
      // function loop() {
      //   // 1. 計算：位置をスピード分だけ進める
      //   spriteX += vx;
      //   spriteY += vy;

      //   // 2. 跳ね返り：壁にぶつかったらスピードを逆転させる
      //   if (spriteX < 0 || spriteX > canvas.width - size) {
      //     vx *= -1; // 横方向を反対に
      //   }
      //   if (spriteY < 0 || spriteY > canvas.height - size) {
      //     vy *= -1; // 縦方向を反対に
      //   }
      //   // 3. 描画：前の絵を消して、新しい位置に描き直す
      //   drawBackground(); // 紺色で塗りつぶす（これで前のゴマちゃんが消える）
      //   ctx.drawImage(spriteImage, spriteX, spriteY, size, size);
      //   // 4. 次のフレームを予約する（1/60秒後にまたloopを呼ぶ）
      //   requestAnimationFrame(loop);
      // }
      function loop() {
        if (isGameStarted) {
          spriteX += vx;
          spriteY += vy;
          if (spriteX < 0 || spriteX > canvas.width - size) {
            vx *= -1;
          }
          if (spriteY < 0 || spriteY > canvas.height - size) {
            vy *= -1;
          }
        }

        drawBackground();
        if (!isGameStarted) {
          // 始まっていない時は、画面中央に「クリックしてスタート」と出す
          ctx.fillStyle = "white";
          ctx.textAlign = "center";
          ctx.fillText(
            "画面をクリックしてスタート！",
            canvas.width / 2,
            canvas.height / 2 + 100
          );
        }
        ctx.drawImage(spriteImage, spriteX, spriteY, size, size);
        requestAnimationFrame(loop);
        /* loop関数の中、ctx.drawImage のすぐ下に追加 */
        // ctx.fillStyle = "white"; // 文字の色を白にする
        // ctx.font = "bold 30px Arial"; // 太さとサイズとフォントを決める
        // ctx.fillText("Score: " + score, 20, 50); // 左上のほうに表示する
        ctx.fillStyle = "white";
        ctx.font = "bold 30px Arial";
        ctx.fillText("Score: " + score, 20, 50);
      }
      const spriteImage = new Image();
      spriteImage.src = "images/goma.png";
      spriteImage.onload = () => {
        const x = canvas.width / 2 - size / 2;
        const y = canvas.height / 2 - size / 2;
        loop();
      };
      // 3. 画用紙のサイズを画面いっぱいに設定する
      //   function resize() {
      //     canvas.width = window.innerWidth;
      //     canvas.height = window.innerHeight;
      //     console.log(canvas.width);
      //     console.log(canvas.height);
      //     drawBackground();
      //  }
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawBackground();
      }

      // 4. 紺色で塗りつぶす関数
      //function drawBackground() {
      // ctx.fillStyle = "#0a0a32";
      // ctx.fillRect(0, 0, canvas.width, canvas.height);
      // }
      function drawBackground() {
        ctx.fillStyle = "#0a0a32";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      // これは、ブラウザ（window）に対して、「『リサイズ（resize）』という出来事が起きたら、
      // 後ろに書いてある『resize』という名前の関数（命令セット）を実行してね！」
      // という予約を入れている状態です。
      // addEventListener: 「耳をすませて待機せよ」という命令です。
      // "resize": 待ち構えるイベントの種類。ブラウザの幅や高さが変わった瞬間のことです。
      // resize（後ろの方）: 実行してほしい関数の名前。
      window.addEventListener("resize", resize);
      // マウスが押された時の処理
      canvas.addEventListener("mousedown", (e) => {
        if (!isGameStarted) {
          isGameStarted = true; // 最初のクリックでゲーム開始！
          return; // 最初のクリックではスコアは増やさない
        }
        // 1. ゴマちゃんの中心（おへそ）の場所を計算
        const centerX = spriteX + size / 2;
        const centerY = spriteY + size / 2;

        // 2. マウスの場所(e.clientX, e.clientY)と、中心の距離を測る
        // Aの2乗 + Bの2乗 = Cの2乗 のルート！
        const diffX = e.clientX - centerX;
        const diffY = e.clientY - centerY;
        const dist = Math.sqrt(Math.pow(diffX, 2) + Math.pow(diffY, 2));

        // 3. もし距離がゴマちゃんの半径（size/2）より小さければ「当たり！」
        if (dist < size / 2) {
          score += 1; // スコアアップ！

          // ゴマちゃんを別の場所にワープさせる（逃げる！）
          spriteX = Math.random() * (canvas.width - size);
          spriteY = Math.random() * (canvas.height - size);

          // 捕まえるたびに少しずつスピードを上げる（やりがいアップ！）
          vx *= 1.1;
          vy *= 1.1;
        }
      });
      resize();
    </script>
  </body>
</html>
