<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ã‚´ãƒã¡ã‚ƒã‚“ã‚’è¿½ãˆ - Fullscreen</title>
    <link rel="icon" href="images/goma.png" type="image/png" />
    <link rel="apple-touch-icon" href="images/goma.png" />
    <meta name="apple-mobile-web-app-title" content="ã‚´ãƒã¡ã‚ƒã‚“ã‚’è¿½ãˆ" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest2.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        touch-action: none; /* 2. ç”»é¢å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ã‚ºãƒ¼ãƒ ã‚’CSSã§æ ¹æœ¬ã‹ã‚‰ç¦æ­¢ */
      }
      body {
        overflow: hidden;
        background-color: #0a0a32;
        width: 100vw;
        height: 100vh;
      }
      canvas {
        display: block;
        /* 3. Canvasã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’ç”»é¢ã´ã£ãŸã‚Šã«å›ºå®š */
        width: 100vw;
        height: 100vh;
      }
      #volume-container {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: move;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        user-select: none;
      }
      .volume-label {
        color: white;
        font-family: sans-serif;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="volume-container">
      <div class="volume-label">ğŸ”Š <span id="volumeValue">70</span>%</div>
      <input type="range" id="volumeSlider" min="0" max="100" value="70" />
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const volumeContainer = document.getElementById("volume-container");
      const volumeSlider = document.getElementById("volumeSlider");
      const volumeValue = document.getElementById("volumeValue");

      let isGameStarted = false;
      let score = 0;
      let spriteX = 0;
      let spriteY = 0;
      //   let vx = 3;
      //   let vy = 3;
      let volume = 70;
      //   const size = 200;ã€€ã¯æ¶ˆã—ã¾ã™ï¼ˆæç”»æ™‚ã«è¨ˆç®—ã™ã‚‹ãŸã‚ï¼‰
      /* ä»Šã® vx, vy, size ã‚’ä»¥ä¸‹ã«æ›¸ãæ›ãˆ */
      let spriteSpeed = [0, 0]; // [æ¨ªã®é€Ÿã•, ç¸¦ã®é€Ÿã•]

      const spriteImage = new Image();
      spriteImage.src = "images/goma.png";
      let isImageLoaded = false;
      spriteImage.onload = () => {
        isImageLoaded = true;
      };

      const catSound = new Audio("images/cat.mp3");
      const specialSound = new Audio("images/special.mp3");

      // 4. é«˜ç”»è³ªãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œã®resizeé–¢æ•°
      function resize() {
        // è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’è¨­å®š
        const displayWidth = window.innerWidth;
        const displayHeight = window.innerHeight;

        // Canvaså†…éƒ¨ã®è§£åƒåº¦ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã«ã´ã£ãŸã‚Šåˆã‚ã›ã‚‹
        canvas.width = displayWidth;
        canvas.height = displayHeight;

        if (!isGameStarted) {
          spriteX = canvas.width / 2;
          spriteY = canvas.height / 2;
        }
        drawBackground();
      }

      window.addEventListener("resize", resize);

      function drawBackground() {
        ctx.fillStyle = "#0a0a32";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "rgba(255, 255, 255, 0.15)";
        const titleFontSize = Math.min(canvas.width / 10, 80);
        ctx.font = `bold ${titleFontSize}px sans-serif`;
        ctx.fillText("ã‚´ãƒã¡ã‚ƒã‚“ã‚’è¿½ãˆ", canvas.width / 2, 100);
      }

      function playSuccessSound() {
        let targetSound = score > 0 && score % 10 === 0 ? specialSound : catSound;
        targetSound.volume = volume / 100;
        targetSound.currentTime = 0;
        targetSound.play().catch(() => {});
      }

      function handleClick(e) {
        if (e.target.closest("#volume-container")) return;

        if (!isGameStarted) {
          isGameStarted = true;
          spriteSpeed = [3, 3]; // ã“ã“ã§ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹
          return;
        }

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        // ä¸­å¿ƒåº§æ¨™(spriteX, Y)ã¨ã®è·é›¢ã‚’æ¸¬ã‚‹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸï¼ï¼‰
        const dist = Math.sqrt(Math.pow(clientX - spriteX, 2) + Math.pow(clientY - spriteY, 2));
        const hitLimit = Math.min(canvas.width, canvas.height) * 0.34;

        if (dist < hitLimit / 2) {
          score++;
          playSuccessSound();
          // ãƒ¯ãƒ¼ãƒ—ä½ç½®ï¼ˆç”»é¢ç«¯ã«åŸ‹ã¾ã‚‰ãªã„ã‚ˆã†ã«å°‘ã—å†…å´ã¸ï¼‰
          spriteX = Math.random() * (canvas.width - 200) + 100;
          spriteY = Math.random() * (canvas.height - 200) + 100;
          spriteSpeed[0] *= 1.05;
          spriteSpeed[1] *= 1.05;
        }
      }
      function update() {
        if (!isGameStarted) return;
        spriteX += spriteSpeed[0];
        spriteY += spriteSpeed[1];

        const bounceMargin = 80; // å£éš›ã§ã®è·³ã­è¿”ã‚Šä½™è£•
        if (spriteX < bounceMargin || spriteX > canvas.width - bounceMargin) spriteSpeed[0] *= -1;
        if (spriteY < bounceMargin || spriteY > canvas.height - bounceMargin) spriteSpeed[1] *= -1;
      }

      function draw() {
        drawBackground(); // ç´ºè‰²ã®å¡—ã‚Šã¤ã¶ã—

        // ã‚´ãƒã¡ã‚ƒã‚“ã®ã‚µã‚¤ã‚ºã‚’ç”»é¢ã®34%ã§è¨ˆç®—
        const currentSize = Math.min(canvas.width, canvas.height) * 0.34;

        if (isImageLoaded) {
          // â˜…ã“ã“ãŒé‡è¦ï¼šä¸­å¿ƒåº§æ¨™(spriteX, spriteY)ã‹ã‚‰ã€ã‚µã‚¤ã‚ºã®åŠåˆ†å¼•ã„ãŸä½ç½®ã«æã
          ctx.drawImage(spriteImage, spriteX - currentSize / 2, spriteY - currentSize / 2, currentSize, currentSize);
        }

        // ã‚¹ã‚³ã‚¢ã¨ã‚¹ã‚¿ãƒ¼ãƒˆæ–‡å­—ï¼ˆç›®æ¨™ã‚³ãƒ¼ãƒ‰ã®ä½ç½®ã«åˆã‚ã›ã‚‹ï¼‰
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height - 100);

        if (!isGameStarted) {
          ctx.fillStyle = "white";
          ctx.fillText("ç”»é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼!", canvas.width / 2, canvas.height / 2 + 100);
        }
      }

      // loopé–¢æ•°ã¯ã“ã‚Œã ã‘ã‚¹ãƒƒã‚­ãƒªã•ã›ã¾ã™
      function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
      }

      ctx.fillStyle = "white";
      ctx.font = "bold 30px Arial";
      ctx.textAlign = "left";
      ctx.fillText("Score: " + score, 20, 50);

      requestAnimationFrame(loop);

      // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆé‡è¤‡ã‚’å‰Šé™¤ã—ã¦æ•´ç†ï¼‰
      canvas.addEventListener("mousedown", handleClick);
      canvas.addEventListener(
        "touchstart",
        (e) => {
          e.preventDefault();
          handleClick(e);
        },
        { passive: false }
      );

      volumeSlider.addEventListener("input", (e) => {
        volume = parseInt(e.target.value);
        volumeValue.textContent = volume;
      });

      // ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
      let isDragging = false;
      let offset = { x: 0, y: 0 };

      const startDrag = (e) => {
        if (e.target === volumeSlider) return;
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        offset.x = clientX - volumeContainer.offsetLeft;
        offset.y = clientY - volumeContainer.offsetTop;
      };

      const doDrag = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        volumeContainer.style.left = Math.max(0, Math.min(window.innerWidth - volumeContainer.offsetWidth, clientX - offset.x)) + "px";
        volumeContainer.style.top = Math.max(0, Math.min(window.innerHeight - volumeContainer.offsetHeight, clientY - offset.y)) + "px";
      };

      volumeContainer.addEventListener("mousedown", startDrag);
      window.addEventListener("mousemove", doDrag);
      window.addEventListener("mouseup", () => (isDragging = false));
      volumeContainer.addEventListener("touchstart", startDrag);
      window.addEventListener("touchmove", doDrag);
      window.addEventListener("touchend", () => (isDragging = false));

      resize();
      loop();
    </script>
  </body>
</html>
